{
	admin off
	persist_config off
	auto_https off
	log {
		format json
	}
	servers {
		trusted_proxies static private_ranges
	}
}

:{$PORT} {
	log {
		output file /var/log/caddy/access.log
		format console
	}

	# Health check
	handle /stub_status {
		respond "OK" 200
	}

	# Import API with large body
	handle /api/import/* {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT} {
			header_up X-Request-Id {http.request.id}
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
		request_body {
			max_size 2GB
		}
	}

	# WebSocket - must match /ws and /ws/*
	@websocket {
		path /ws /ws/*
		header Connection *Upgrade*
		header Upgrade websocket
	}
	handle @websocket {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT} {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {scheme}
			flush_interval -1
			transport http {
				read_timeout 86400s
			}
		}
	}

	# WebSocket fallback for non-upgrade requests
	handle /ws/* {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT} {
			header_up Host {host}
		}
	}

	# Chat API (long timeout for streaming)
	handle /api/chat/* {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT} {
			header_up Host {host}
			transport http {
				response_header_timeout 600s
			}
		}
	}

	# API
	handle /api/* {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT} {
			header_up X-Request-Id {http.request.id}
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
	}

	# GoTrue Auth
	handle_path /gotrue/* {
		reverse_proxy {$ENV_GOTRUE}:{$ENV_GOTRUE_PORT} {
			header_up Host {http.request.host}
		}
	}

	# Minio Console
	handle_path /minio/* {
		reverse_proxy {$ENV_MINIO}:{$ENV_MINIO_PORT} {
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
	}

	# AI API
	handle /ai/* {
		reverse_proxy {$ENV_APPFLOWY_AI}:{$ENV_APPFLOWY_AI_PORT} {
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
	}

	# AppFlowy Web App
	handle /web/* {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT} {
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
	}

	handle /app/* {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT} {
			header_up Host {http.request.host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.scheme}
		}
	}

	# Static assets for web app
	handle /static/* {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT} {
			header_up Host {http.request.host}
		}
	}

	# Other web app assets
	handle /appflowy.ico {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT}
	}

	handle /og-image.png {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT}
	}

	handle /assets/* {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT}
	}

	# Root redirect to web app
	handle / {
		redir /web permanent
	}

	# Admin Frontend / Console (must match /console and /console/*)
	@console path /console /console/*
	handle @console {
		reverse_proxy {$ENV_ADMIN_FRONTEND}:{$ENV_ADMIN_FRONTEND_PORT} {
			header_up Host {host}
		}
	}

	# Default fallback to web app
	handle {
		reverse_proxy {$ENV_APPFLOWY_WEB}:{$ENV_APPFLOWY_WEB_PORT} {
			header_up Host {host}
		}
	}
}
